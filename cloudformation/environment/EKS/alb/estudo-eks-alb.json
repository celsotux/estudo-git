{
    "AWSTemplateFormatVersion": "2010-09-09",
    "Description": "Cria um Application Load Balancer (ALB) para receber requisições externas e encaminhá-las para uma aplicação no Amazon EKS",
    "Parameters": {
      "VpcStackName": {
        "Type": "String",
        "Description": "Nome da stack da VPC (estudo-vpc-eks)"
      }
    },
    "Resources": {
      "ALBSecurityGroup": {
        "Type": "AWS::EC2::SecurityGroup",
        "Properties": {
          "GroupDescription": "Security group for ALB to allow HTTP traffic",
          "VpcId": {
            "Fn::ImportValue": {
              "Fn::Sub": "${VpcStackName}-VPCID"
            }
          },
          "SecurityGroupIngress": [
            {
              "IpProtocol": "tcp",
              "FromPort": 80,
              "ToPort": 80,
              "CidrIp": "0.0.0.0/0"
            }
          ]
        }
      },
      "LoadBalancer": {
        "Type": "AWS::ElasticLoadBalancingV2::LoadBalancer",
        "Properties": {
          "Name": "MyALB",
          "Scheme": "internet-facing",
          "Subnets": [
            {
              "Fn::ImportValue": {
                "Fn::Sub": "${VpcStackName}-PublicSubnet1"
              }
            },
            {
              "Fn::ImportValue": {
                "Fn::Sub": "${VpcStackName}-PublicSubnet2"
              }
            }
          ],
          "SecurityGroups": [
            {
              "Ref": "ALBSecurityGroup"
            }
          ],
          "Type": "application"
        }
      },
      "ALBListener": {
        "Type": "AWS::ElasticLoadBalancingV2::Listener",
        "Properties": {
          "DefaultActions": [
            {
              "Type": "forward",
              "TargetGroupArn": {
                "Ref": "TargetGroup"
              }
            }
          ],
          "LoadBalancerArn": {
            "Ref": "LoadBalancer"
          },
          "Port": 80,
          "Protocol": "HTTP"
        }
      },
      "TargetGroup": {
        "Type": "AWS::ElasticLoadBalancingV2::TargetGroup",
        "Properties": {
          "Name": "MyTargetGroup",
          "Port": 80,
          "Protocol": "HTTP",
          "TargetType": "ip",
          "VpcId": {
            "Fn::ImportValue": {
              "Fn::Sub": "${VpcStackName}-VPCID"
            }
          },
          "HealthCheckEnabled": true,
          "HealthCheckPath": "/health",
          "HealthCheckIntervalSeconds": 30,
          "HealthCheckTimeoutSeconds": 5,
          "HealthyThresholdCount": 2,
          "UnhealthyThresholdCount": 2
        }
      }
    }
  }
  