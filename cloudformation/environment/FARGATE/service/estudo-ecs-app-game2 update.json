{
    "AWSTemplateFormatVersion": "2010-09-09",
    "Parameters": {
      "VpcStackName": {
        "Type": "String",
        "Description": "Nome da stack da VPC onde o serviço será implantado"
      }
    },
    "Resources": {
      "ECSExecutionRole": {
        "Type": "AWS::IAM::Role",
        "Properties": {
          "AssumeRolePolicyDocument": {
            "Version": "2012-10-17",
            "Statement": [
              {
                "Effect": "Allow",
                "Principal": {
                  "Service": "ecs-tasks.amazonaws.com"
                },
                "Action": "sts:AssumeRole"
              }
            ]
          },
          "Policies": [
            {
              "PolicyName": "ecs-service",
              "PolicyDocument": {
                "Version": "2012-10-17",
                "Statement": [
                  {
                    "Effect": "Allow",
                    "Action": [
                      "ecs:CreateService",
                      "ecs:DeleteService",
                      "ecs:UpdateService"
                    ],
                    "Resource": "*"
                  }
                ]
              }
            }
          ]
        }
      },
      "ECSTaskDefinition": {
        "Type": "AWS::ECS::TaskDefinition",
        "Properties": {
          "Family": "estudo-dev-app-game20",
          "Cpu": "256",
          "Memory": "512",
          "NetworkMode": "awsvpc",
          "RequiresCompatibilities": ["FARGATE"],
          "ExecutionRoleArn": { "Fn::GetAtt": ["ECSExecutionRole", "Arn"] },
          "ContainerDefinitions": [
            {
              "Name": "estudo-dev-app-game20-container",
              "Image": "791918029132.dkr.ecr.us-east-1.amazonaws.com/estudo:hit-game-app20",
              "PortMappings": [{ "ContainerPort": 80 }]
            }
          ]
        }
      },
      "ECSFargateService": {
        "Type": "AWS::ECS::Service",
        "Properties": {
          "Cluster": "estudo-dev-cluster1",
          "ServiceName": "estudo-dev-app-game20",
          "TaskDefinition": { "Ref": "ECSTaskDefinition" },
          "LaunchType": "FARGATE",
          "DesiredCount": 1,
          "NetworkConfiguration": {
            "AwsvpcConfiguration": {
              "AssignPublicIp": "ENABLED",
              "Subnets": { "Fn::ImportValue": { "Fn::Sub": "${VpcStackName}-SubnetIds" } },
              "SecurityGroups": [{ "Fn::GetAtt": ["AppSecurityGroup", "GroupId"] }]
            }
          },
          "LoadBalancers": [
            {
              "TargetGroupArn": { "Ref": "AppTargetGroup" },
              "ContainerName": "estudo-dev-app-game20-container",
              "ContainerPort": 80
            }
          ]
        }
      },
      "AppSecurityGroup": {
        "Type": "AWS::EC2::SecurityGroup",
        "Properties": {
          "VpcId": { "Fn::ImportValue": { "Fn::Sub": "${VpcStackName}-VpcId" } },
          "GroupDescription": "Security group for ECS service",
          "SecurityGroupIngress": [
            {
              "IpProtocol": "tcp",
              "FromPort": 80,
              "ToPort": 80,
              "CidrIp": "0.0.0.0/0"
            }
          ]
        }
      },
      "AppTargetGroup": {
        "Type": "AWS::ElasticLoadBalancingV2::TargetGroup",
        "Properties": {
          "Name": "estudo-dev-app-game20-target-group",
          "Port": 80,
          "Protocol": "HTTP",
          "TargetType": "ip"
        }
      }
    }
  }
  